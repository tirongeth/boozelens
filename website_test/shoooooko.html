<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSG Party Tracker 🎉 | Live BAC Monitor</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-gradient: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            --accent-gradient: linear-gradient(45deg, #00ff88, #00d4ff, #ff00ff);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Animated background */
        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            z-index: -2;
            animation: gradient 15s ease infinite;
            background-size: 400% 400%;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Floating particles */
        .particles {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            from {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            to {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Navigation Menu */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 1000;
            padding: 15px 0;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            font-size: 1.5em;
            font-weight: bold;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-menu {
            display: flex;
            gap: 30px;
            list-style: none;
        }
        
        .nav-item {
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--accent-gradient);
            transition: left 0.3s ease;
            z-index: -1;
        }
        
        .nav-item:hover::before {
            left: 0;
        }
        
        .nav-item:hover {
            color: #000;
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }
        
        /* Mobile menu toggle - make it visible */
        .mobile-menu-toggle {
            display: none;
            font-size: 1.5em;
            cursor: pointer;
            color: white;
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 10px 20px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            z-index: 100;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff88;
        }
        
        /* Alert Banner */
        .alert-banner {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            background: rgba(255, 68, 68, 0.9);
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 999;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .alert-banner.show {
            transform: translateY(0);
        }
        
        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 20px;
        }
        
        /* Header */
        header {
            text-align: center;
            padding: 40px 0;
            position: relative;
        }
        
        h1 {
            font-size: 4em;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: glow 2s ease-in-out infinite alternate;
            margin-bottom: 10px;
        }
        
        @keyframes glow {
            from { filter: drop-shadow(0 0 20px rgba(0, 255, 136, 0.5)); }
            to { filter: drop-shadow(0 0 30px rgba(0, 212, 255, 0.8)); }
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.8;
            margin-bottom: 30px;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #00ff88, #00d4ff);
            color: #000;
            font-weight: bold;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff4444, #ff0088);
        }
        
        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        /* Cards */
        .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 255, 136, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--accent-gradient);
            border-radius: 20px;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
        }
        
        .card:hover::before {
            opacity: 0.3;
        }
        
        /* Friend Cards with Animation */
        .friend-card {
            cursor: pointer;
            position: relative;
        }
        
        .friend-card.pulse {
            animation: cardPulse 0.5s ease;
        }
        
        @keyframes cardPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .friend-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            margin-bottom: 15px;
        }
        
        .friend-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .bac-value {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
            display: flex;
            align-items: baseline;
            gap: 10px;
        }
        
        .bac-trend {
            font-size: 0.5em;
        }
        
        .trend-up { color: #ff4444; }
        .trend-down { color: #00ff88; }
        
        .bac-safe { color: #00ff88; }
        .bac-caution { color: #ffcc00; }
        .bac-danger { color: #ff4444; }
        .bac-critical { 
            color: #ff0088;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { opacity: 0.5; }
        }
        
        .friend-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .location-tag {
            font-size: 0.9em;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Party Stats */
        .party-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .stat-card {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        /* Games Section */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .game-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .game-card:hover {
            transform: translateY(-10px) rotateZ(-2deg);
            box-shadow: 0 20px 40px rgba(0, 255, 136, 0.3);
        }
        
        .game-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .game-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .game-players {
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 40px 0;
        }
        
        .achievement {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .achievement.unlocked {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.5);
            animation: achievementUnlock 0.5s ease;
        }
        
        @keyframes achievementUnlock {
            0% { transform: scale(0) rotate(180deg); }
            50% { transform: scale(1.2) rotate(360deg); }
            100% { transform: scale(1) rotate(360deg); }
        }
        
        .achievement-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            filter: grayscale(1);
            transition: filter 0.3s ease;
        }
        
        .achievement.unlocked .achievement-icon {
            filter: grayscale(0);
        }
        
        .achievement-name {
            font-size: 0.9em;
            font-weight: bold;
        }
        
        /* Music Visualizer */
        .visualizer {
            height: 200px;
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            gap: 5px;
        }
        
        .bar {
            width: 100%;
            background: var(--accent-gradient);
            border-radius: 5px 5px 0 0;
            transition: height 0.1s ease;
        }
        
        /* Chat Section */
        .chat-container {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 20px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            animation: slideIn 0.3s ease;
        }
        
        .chat-message.own {
            background: rgba(0, 255, 136, 0.2);
            text-align: right;
        }
        
        .chat-author {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1em;
        }
        
        /* Emergency Section */
        .emergency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .emergency-card {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .emergency-card:hover {
            transform: scale(1.05);
            background: rgba(255, 68, 68, 0.2);
            box-shadow: 0 10px 30px rgba(255, 68, 68, 0.3);
        }
        
        .emergency-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        /* Leaderboard */
        .leaderboard {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
        }
        
        .leaderboard h2 {
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(10px);
        }
        
        .rank {
            font-size: 1.5em;
            font-weight: bold;
            width: 50px;
        }
        
        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            animation: modalIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0, 255, 136, 0.9);
            color: #000;
            padding: 15px 25px;
            border-radius: 10px;
            animation: slideInRight 0.3s ease;
            z-index: 3000;
            cursor: pointer;
            max-width: 300px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }
        
        /* Collapsible Chart Container */
        .chart-container {
            position: relative;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .chart-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 5px 15px;
            cursor: pointer;
            font-size: 0.9em;
            z-index: 10;
        }
        
        .chart-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .chart-wrapper {
            height: 250px;
            transition: height 0.3s ease;
            overflow: hidden;
        }
        
        .chart-wrapper.collapsed {
            height: 0;
        }
        
        /* Friend Management */
        .friend-management {
            margin: 20px 0;
        }
        
        .add-friend-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .add-friend-form input {
            flex: 1;
            padding: 10px 20px;
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }
        
        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 212, 255, 0.1));
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .info-box h3 {
            margin-bottom: 15px;
            color: #00ff88;
        }
        
        .info-box p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .info-box code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* Settings Form */
        .settings-form {
            display: grid;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .form-group label {
            font-weight: bold;
            opacity: 0.9;
        }
        
        .form-group input,
        .form-group textarea {
            padding: 12px 20px;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1em;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Mobile-First Responsive Design */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .nav-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, 0.95);
                flex-direction: column;
                padding: 20px;
                gap: 10px;
                border-radius: 0 0 20px 20px;
            }
            
            .nav-menu.show {
                display: flex;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .party-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .games-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .achievements-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .emergency-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .friend-card {
                padding: 20px;
            }
            
            .bac-value {
                font-size: 2em;
            }
            
            .stat-value {
                font-size: 1.5em;
            }
            
            .weather-widget {
                position: static;
                margin: 20px auto;
                width: fit-content;
            }
            
            .modal-content {
                margin: 20px;
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .game-container {
                padding: 20px;
            }
            
            .timer-display {
                font-size: 3em;
            }
            
            .question-card {
                font-size: 1.2em;
                padding: 20px;
            }
            
            .leaderboard h2 {
                font-size: 1.5em;
            }
            
            /* Fix drink section on mobile */
            #drinks .card {
                padding: 15px;
            }
            
            #drinkType, #drinkAmount, #alcoholPercent {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .container {
                padding: 80px 10px 20px;
            }
            
            /* Fix overlapping elements */
            .connection-status {
                bottom: 80px;
                font-size: 0.8em;
            }
            
            /* Better touch targets */
            .nav-item, .btn, .card {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
        }
        
        /* Tablet adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .games-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Prevent horizontal scroll on mobile */
        html, body {
            overflow-x: hidden;
            max-width: 100%;
        }
        
        /* Fix iOS button styles */
        input, select, button {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        /* Better mobile form inputs */
        input[type="number"],
        input[type="text"],
        input[type="tel"],
        select {
            font-size: 16px;
            padding: 12px;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Loading state */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Error state */
        .error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: #ff4444;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00ff88;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Party Mode */
        body.party-mode {
            animation: partyColors 2s linear infinite;
        }
        
        @keyframes partyColors {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Game Overlay */
        .game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .game-overlay.show {
            display: flex;
        }
        
        .game-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: gameIn 0.5s ease;
        }
        
        @keyframes gameIn {
            from {
                opacity: 0;
                transform: scale(0.8) rotateX(30deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotateX(0);
            }
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .game-title {
            font-size: 2em;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .close-game {
            font-size: 2em;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        
        .close-game:hover {
            opacity: 1;
            transform: rotate(90deg);
        }
        
        /* Timer Display */
        .timer-display {
            font-size: 4em;
            font-weight: bold;
            text-align: center;
            margin: 30px 0;
            font-variant-numeric: tabular-nums;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Score Display */
        .score-display {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
        }
        
        .team-score {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            min-width: 150px;
        }
        
        .team-name {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        
        .team-points {
            font-size: 3em;
            font-weight: bold;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Question Card */
        .question-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            margin: 30px 0;
            text-align: center;
            font-size: 1.5em;
            line-height: 1.6;
            animation: questionIn 0.5s ease;
        }
        
        @keyframes questionIn {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Location Map */
        .location-map {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            height: 300px;
            position: relative;
            overflow: hidden;
        }
        
        .location-dot {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--accent-gradient);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        /* First Aid Card */
        .first-aid-card {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .first-aid-step {
            margin: 15px 0;
            padding-left: 30px;
            position: relative;
        }
        
        .first-aid-step::before {
            content: attr(data-step);
            position: absolute;
            left: 0;
            top: 0;
            width: 25px;
            height: 25px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }
        
        /* Buddy System */
        .buddy-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .buddy-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .buddy-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 255, 136, 0.5);
        }
        
        .buddy-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .buddy-status.online {
            background: #00ff88;
            animation: pulse 2s infinite;
        }
        
        .buddy-status.offline {
            background: #666;
        }
        
        /* Settings Saved Animation */
        @keyframes settingsSaved {
            0% {
                transform: scale(0) rotate(180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(360deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(360deg);
                opacity: 1;
            }
        }
        
        .settings-saved {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5em;
            animation: settingsSaved 0.5s ease;
            z-index: 4000;
        }
        
        /* Advanced Stats */
        .advanced-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .stat-chart {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            height: 250px;
        }
        
        /* Prediction Engine */
        .prediction-card {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 212, 255, 0.1));
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }
        
        .prediction-value {
            font-size: 2em;
            font-weight: bold;
            margin: 20px 0;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Weather Widget */
        .weather-widget {
            position: fixed;
            top: 100px;
            left: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
            min-width: 150px;
        }
        
        .weather-temp {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .weather-condition {
            opacity: 0.8;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="particles" id="particles"></div>
    
    <!-- Alert Banner -->
    <div class="alert-banner" id="alertBanner">
        <span id="alertText"></span>
    </div>
    
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-beer"></i>
                HSG Party Tracker
            </div>
            <ul class="nav-menu" id="navMenu">
                <li class="nav-item active" onclick="switchSection('dashboard')">
                    <i class="fas fa-home"></i> Dashboard
                </li>
                <li class="nav-item" onclick="switchSection('friends')">
                    <i class="fas fa-users"></i> Friends
                </li>
                <li class="nav-item" onclick="switchSection('games')">
                    <i class="fas fa-gamepad"></i> Games
                </li>
                <li class="nav-item" onclick="switchSection('achievements')">
                    <i class="fas fa-trophy"></i> Achievements
                </li>
                <li class="nav-item" onclick="switchSection('drinks')">
                    <i class="fas fa-beer"></i> Drinks
                </li>
                <li class="nav-item" onclick="switchSection('emergency')">
                    <i class="fas fa-ambulance"></i> Emergency
                </li>
                <li class="nav-item" onclick="switchSection('settings')">
                    <i class="fas fa-cog"></i> Settings
                </li>
            </ul>
            <div class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </nav>
    
    <!-- Connection Status -->
    <div class="connection-status">
        <span class="status-dot"></span>
        <span id="connectionStatus">Connecting...</span>
    </div>
    
    <div class="container">
        <header>
            <h1>🎉 HSG Party Central 🎉</h1>
            <p class="subtitle">Where memories are made and safety comes first!</p>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="startPartyMode()">
                    <i class="fas fa-music"></i> Party Mode
                </button>
                <button class="btn" onclick="showModal('checkin')">
                    <i class="fas fa-location-dot"></i> Check In
                </button>
                <button class="btn" onclick="callUber()">
                    <i class="fas fa-taxi"></i> Call Uber
                </button>
                <button class="btn btn-danger" onclick="showModal('emergency')">
                    <i class="fas fa-exclamation-triangle"></i> Emergency
                </button>
            </div>
        </header>
        
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="party-stats">
                <div class="stat-card" onclick="showNotification('Party started 3 hours ago!')">
                    <div class="stat-icon">🎊</div>
                    <div class="stat-value" id="partyAverage">0.00‰</div>
                    <div class="stat-label">Party Average</div>
                </div>
                <div class="stat-card" onclick="showModal('safe-friends')">
                    <div class="stat-icon">✅</div>
                    <div class="stat-value" id="safeFriends">0</div>
                    <div class="stat-label">Safe to Drive</div>
                </div>
                <div class="stat-card" onclick="showModal('locations')">
                    <div class="stat-icon">📍</div>
                    <div class="stat-value" id="activeLocations">3</div>
                    <div class="stat-label">Party Spots</div>
                </div>
                <div class="stat-card" onclick="showHydrationReminder()">
                    <div class="stat-icon">💧</div>
                    <div class="stat-value" id="hydrationTime">15m</div>
                    <div class="stat-label">Until Water Break</div>
                </div>
            </div>
            
            <div class="visualizer" id="visualizer">
                <!-- Music visualizer bars will be generated here -->
            </div>
            
            <div class="dashboard" id="friendsGrid">
                <!-- Friend cards will be dynamically inserted here -->
            </div>
            
            <div class="leaderboard">
                <h2>🏆 Tonight's Champions 🏆</h2>
                <div id="leaderboardList">
                    <!-- Leaderboard items will be inserted here -->
                </div>
            </div>
            
            <div class="info-box">
                <h3>🔌 How to Connect Your Breathalyzer</h3>
                <p><strong>For Arduino/ESP32 Devices:</strong></p>
                <ol style="margin-left: 20px;">
                    <li>Upload the provided code to your device</li>
                    <li>Replace <code>YOUR_WIFI_SSID</code> and <code>YOUR_WIFI_PASSWORD</code> in the code</li>
                    <li>The device will automatically send readings to this app</li>
                    <li>Your BAC will update in real-time on the dashboard</li>
                </ol>
                <p><strong>Demo Mode:</strong> Currently showing simulated data. Change <code>DEMO_MODE = false</code> in the code to use real data.</p>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message">
                        <div class="chat-author">System</div>
                        <div>Welcome to HSG Party Chat! Stay safe and have fun! 🎉</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleChatEnter(event)">
                    <button class="btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Friends Section -->
        <section id="friends" class="section">
            <h2>👥 Friends Management</h2>
            
            <div class="card friend-management">
                <h3>Add Friend</h3>
                <div class="add-friend-form">
                    <input type="text" id="friendName" placeholder="Friend's name">
                    <input type="text" id="friendDevice" placeholder="Device ID (optional)">
                    <button class="btn btn-primary" onclick="addFriend()">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
            </div>
            
            <div class="dashboard" id="friendsList">
                <!-- Friends list will be populated here -->
            </div>
        </section>
        
        <!-- Games Section -->
        <section id="games" class="section">
            <h2>🎮 Party Games 🎮</h2>
            <div class="games-grid">
                <div class="game-card" onclick="startGame('never-have-i-ever')">
                    <div class="game-icon">🙊</div>
                    <div class="game-title">Never Have I Ever</div>
                    <div class="game-players">2-20 players</div>
                </div>
                <div class="game-card" onclick="startGame('truth-or-dare')">
                    <div class="game-icon">🎯</div>
                    <div class="game-title">Truth or Dare</div>
                    <div class="game-players">3-10 players</div>
                </div>
                <div class="game-card" onclick="startGame('kings-cup')">
                    <div class="game-icon">👑</div>
                    <div class="game-title">King's Cup</div>
                    <div class="game-players">4-12 players</div>
                </div>
                <div class="game-card" onclick="startGame('beer-pong')">
                    <div class="game-icon">🏓</div>
                    <div class="game-title">Beer Pong Tracker</div>
                    <div class="game-players">2v2</div>
                </div>
                <div class="game-card" onclick="startGame('flip-cup')">
                    <div class="game-icon">🥤</div>
                    <div class="game-title">Flip Cup Timer</div>
                    <div class="game-players">Teams</div>
                </div>
                <div class="game-card" onclick="startGame('trivia')">
                    <div class="game-icon">🧠</div>
                    <div class="game-title">HSG Trivia</div>
                    <div class="game-players">Unlimited</div>
                </div>
            </div>
        </section>
        
        <!-- Achievements Section -->
        <section id="achievements" class="section">
            <h2>🏅 Party Achievements 🏅</h2>
            <div class="achievements-grid">
                <div class="achievement unlocked" title="Joined your first party!">
                    <div class="achievement-icon">🎉</div>
                    <div class="achievement-name">First Timer</div>
                </div>
                <div class="achievement unlocked" title="Stayed safe all night">
                    <div class="achievement-icon">😇</div>
                    <div class="achievement-name">Responsible</div>
                </div>
                <div class="achievement" title="Win 5 party games">
                    <div class="achievement-icon">🏆</div>
                    <div class="achievement-name">Game Master</div>
                </div>
                <div class="achievement" title="Check in at 10 parties">
                    <div class="achievement-icon">📍</div>
                    <div class="achievement-name">Party Animal</div>
                </div>
                <div class="achievement" title="Help a friend get home safe">
                    <div class="achievement-icon">🦸</div>
                    <div class="achievement-name">Guardian Angel</div>
                </div>
                <div class="achievement" title="Stay hydrated for 3 hours">
                    <div class="achievement-icon">💧</div>
                    <div class="achievement-name">Hydro Homie</div>
                </div>
                <div class="achievement" title="Dance for 30 minutes straight">
                    <div class="achievement-icon">🕺</div>
                    <div class="achievement-name">Dance Machine</div>
                </div>
                <div class="achievement" title="Make it to sunrise">
                    <div class="achievement-icon">🌅</div>
                    <div class="achievement-name">Sunrise Warrior</div>
                </div>
            </div>
        </section>
        
        <!-- Drinks Section -->
        <section id="drinks" class="section">
            <h2>🍻 Drink Tracker 🍻</h2>
            
            <div class="card" style="margin-bottom: 30px;">
                <h3>Log a Drink</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div>
                        <label style="display: block; margin-bottom: 10px;">Drink Type:</label>
                        <select id="drinkType" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;">
                            <option value="beer">🍺 Beer</option>
                            <option value="wine">🍷 Wine</option>
                            <option value="shot">🥃 Shot</option>
                            <option value="cocktail">🍸 Cocktail</option>
                            <option value="mixed">🥤 Mixed Drink</option>
                            <option value="champagne">🥂 Champagne</option>
                            <option value="water">💧 Water</option>
                            <option value="other">🍹 Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 10px;">Amount (ml):</label>
                        <input type="number" id="drinkAmount" placeholder="330" value="330" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 10px;">Alcohol %:</label>
                        <input type="number" id="alcoholPercent" placeholder="5" value="5" step="0.1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="logDrink()">
                    <i class="fas fa-plus"></i> Add Drink
                </button>
            </div>
            
            <div class="party-stats">
                <div class="stat-card">
                    <div class="stat-icon">🍺</div>
                    <div class="stat-value" id="totalDrinks">0</div>
                    <div class="stat-label">Total Drinks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🥃</div>
                    <div class="stat-value" id="totalAlcohol">0ml</div>
                    <div class="stat-label">Pure Alcohol</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">💧</div>
                    <div class="stat-value" id="totalWater">0</div>
                    <div class="stat-label">Waters</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⚡</div>
                    <div class="stat-value" id="drinkRate">0</div>
                    <div class="stat-label">Drinks/Hour</div>
                </div>
            </div>
            
            <div class="card chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3>📊 Drink Distribution</h3>
                    <button class="chart-toggle" onclick="toggleChart()">
                        <span id="chartToggleText">Hide Chart</span>
                    </button>
                </div>
                <div class="chart-wrapper" id="chartWrapper">
                    <canvas id="drinkChart" width="400" height="250"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3>📜 Drink History</h3>
                <div id="drinkHistory" style="max-height: 400px; overflow-y: auto;">
                    <!-- Drink history will be populated here -->
                </div>
            </div>
            
            <div class="card" style="background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3);">
                <h3>🚨 Emergency Information</h3>
                <div id="emergencyDrinkInfo" style="margin: 20px 0;">
                    <p><strong>For First Responders:</strong></p>
                    <div id="emergencySummary">
                        <!-- Emergency summary will be populated here -->
                    </div>
                </div>
                <button class="btn btn-danger" onclick="showEmergencyReport()">
                    <i class="fas fa-file-medical"></i> Generate Emergency Report
                </button>
            </div>
        </section>
        
        <!-- Emergency Section -->
        <section id="emergency" class="section">
            <h2>🚨 Emergency Services 🚨</h2>
            <div class="emergency-grid">
                <div class="emergency-card" onclick="callEmergency('ambulance')">
                    <div class="emergency-icon">🚑</div>
                    <div class="game-title">Call Ambulance</div>
                    <div class="game-players">Emergency: 112</div>
                </div>
                <div class="emergency-card" onclick="callEmergency('campus-security')">
                    <div class="emergency-icon">👮</div>
                    <div class="game-title">Campus Security</div>
                    <div class="game-players">HSG: +41 71 224 2424</div>
                </div>
                <div class="emergency-card" onclick="callEmergency('taxi')">
                    <div class="emergency-icon">🚕</div>
                    <div class="game-title">Safe Ride Home</div>
                    <div class="game-players">Multiple Options</div>
                </div>
                <div class="emergency-card" onclick="showModal('first-aid')">
                    <div class="emergency-icon">🏥</div>
                    <div class="game-title">First Aid Guide</div>
                    <div class="game-players">Quick Help</div>
                </div>
                <div class="emergency-card" onclick="showModal('buddy-system')">
                    <div class="emergency-icon">👥</div>
                    <div class="game-title">Find My Buddy</div>
                    <div class="game-players">Location Sharing</div>
                </div>
                <div class="emergency-card" onclick="showModal('sober-friend')">
                    <div class="emergency-icon">🤝</div>
                    <div class="game-title">Call Sober Friend</div>
                    <div class="game-players">Designated Helpers</div>
                </div>
            </div>
        </section>
        
        <!-- Settings Section -->
        <section id="settings" class="section">
            <h2>⚙️ Settings ⚙️</h2>
            <div class="card">
                <h3>Profile Settings</h3>
                <div class="settings-form">
                    <div class="form-group">
                        <label>Your Name:</label>
                        <input type="text" id="userName" placeholder="Enter your name">
                    </div>
                    <div class="form-group">
                        <label>Home Address:</label>
                        <textarea id="homeAddress" placeholder="Enter your home address for quick Uber rides"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Emergency Contact:</label>
                        <input type="tel" id="emergencyContact" placeholder="+41 XX XXX XX XX">
                    </div>
                    <div class="form-group">
                        <label>Medical Information (allergies, conditions, etc.):</label>
                        <textarea id="medicalInfo" placeholder="Any medical information emergency services should know"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Safety Notes:</label>
                        <textarea id="safetyNotes" placeholder="Any other safety information (medications, etc.)"></textarea>
                    </div>
                    <div style="margin: 20px 0;">
                        <label>
                            <input type="checkbox" id="shareLocation"> Share location with friends
                        </label>
                    </div>
                    <div style="margin: 20px 0;">
                        <label>
                            <input type="checkbox" id="notifications" checked> Enable notifications
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3>⚡ Quick Actions</h3>
                <div style="display: grid; gap: 10px; margin-top: 20px;">
                    <button class="btn" onclick="exportData()">
                        <i class="fas fa-download"></i> Export All Data
                    </button>
                    <button class="btn" onclick="clearDrinkHistory()">
                        <i class="fas fa-trash"></i> Clear Drink History
                    </button>
                    <button class="btn btn-danger" onclick="resetApp()">
                        <i class="fas fa-redo"></i> Reset App
                    </button>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div id="modalBody"></div>
        </div>
    </div>
    
    <script>
        // ========================================
        // FIREBASE CONFIGURATION - YOUR REAL CONFIG
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCuOjiHa8C0jgAte40E774CRJROTWTUdmg",
            authDomain: "hsg-party-tracker.firebaseapp.com",
            databaseURL: "https://hsg-party-tracker-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hsg-party-tracker",
            storageBucket: "hsg-party-tracker.firebasestorage.app",
            messagingSenderId: "1047483086606",
            appId: "1:1047483086606:web:a02d77baacd21166fb095f",
            measurementId: "G-VFS4W30Z7P"
        };
        
        // Change this to false to use real Firebase data
        const DEMO_MODE = true; // Set to false when you have real breathalyzer!
        
        // ========================================
        // GLOBAL VARIABLES AND DATA
        // ========================================
        let partyData = {};
        let currentUser = localStorage.getItem('userName') || 'You';
        let partyMode = false;
        let currentGame = null;
        let gameScores = { team1: 0, team2: 0 };
        let partyStartTime = Date.now();
        let achievements = {
            firstTimer: true,
            responsible: false,
            gameMaster: false,
            partyAnimal: false,
            guardianAngel: false,
            hydroHomie: false,
            danceMachine: false,
            sunriseWarrior: false
        };
        let locationHistory = [];
        let drinkHistory = [];
        let drinkChart = null;
        let chartVisible = true;
        
        // Drink presets
        const drinkPresets = {
            beer: { amount: 330, alcohol: 5, emoji: '🍺' },
            wine: { amount: 150, alcohol: 12, emoji: '🍷' },
            shot: { amount: 40, alcohol: 40, emoji: '🥃' },
            cocktail: { amount: 200, alcohol: 15, emoji: '🍸' },
            mixed: { amount: 250, alcohol: 10, emoji: '🥤' },
            champagne: { amount: 150, alcohol: 12, emoji: '🥂' },
            water: { amount: 250, alcohol: 0, emoji: '💧' },
            other: { amount: 200, alcohol: 5, emoji: '🍹' }
        };

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const dotElement = document.querySelector('.status-dot');
    
            if (statusElement && dotElement) {
                if (connected) {
                    statusElement.textContent = 'Connected';
                    dotElement.style.background = '#00ff88';
                } else {
                    statusElement.textContent = 'Offline';
                    dotElement.style.background = '#ff4444';
                }
            }
        }
        
        // ========================================
        // FIREBASE INITIALIZATION
        // ========================================
        let database = null;
        
        function initializeFirebase() {
            if (!DEMO_MODE) {
                try {
                    // Initialize Firebase
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    
                    // Set up listeners
                    setupFirebaseListeners();
                    
                    console.log('Firebase initialized successfully');
                    showNotification('✅ Connected to Firebase!');
                    updateConnectionStatus(true);
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    showNotification('❌ Firebase connection failed. Running in demo mode.');
                    updateConnectionStatus(false);
                }
            } else {
                updateConnectionStatus(false);
                showNotification('🎮 Running in DEMO MODE - Connect a real breathalyzer for live data!');
            }
        }
        
        // Setup Firebase listeners
        function setupFirebaseListeners() {
            if (!database) return;
            
            // Listen for breathalyzer readings
            database.ref('readings').on('child_added', (snapshot) => {
                const reading = snapshot.val();
                processBreathalyzerReading(reading);
            });
            
            // Listen for user updates
            database.ref('users').on('value', (snapshot) => {
                const users = snapshot.val();
                if (users) {
                    updatePartyData(users);
                }
            });
            
            // Connection status
            database.ref('.info/connected').on('value', (snapshot) => {
                const connected = snapshot.val();
                updateConnectionStatus(connected);
            });
        }
        
        // Process incoming breathalyzer reading
        function processBreathalyzerReading(reading) {
            if (!reading) return;
            
            // Find or create user
            const userId = reading.device || 'unknown';
            const userName = reading.user || 'Anonymous';
            
            if (!partyData[userId]) {
                partyData[userId] = {
                    name: userName,
                    bac: 0,
                    lastUpdate: Date.now(),
                    location: reading.location || 'Unknown',
                    trend: 'steady',
                    history: [],
                    device: reading.device
                };
            }
            
            // Update BAC
            const oldBac = partyData[userId].bac;
            partyData[userId].bac = reading.bac || 0;
            partyData[userId].lastUpdate = Date.now();
            partyData[userId].trend = reading.bac > oldBac ? 'up' : reading.bac < oldBac ? 'down' : 'steady';
            
            // Add to history
            partyData[userId].history.push({
                time: Date.now(),
                value: reading.bac
            });
            
            // Update UI
            updateUI();
            
            // Show notification
            showNotification(`📊 ${userName}: ${reading.bac.toFixed(3)}‰`);
        }
        
        // Update party data from Firebase
        function updatePartyData(users) {
            Object.entries(users).forEach(([userId, userData]) => {
                partyData[userId] = {
                    ...userData,
                    lastUpdate: Date.now()
                };
            });
            updateUI();
        }
        
        // Error boundary
        window.addEventListener('error', (e) => {
            console.error('Application error:', e);
            showNotification('⚠️ Something went wrong. Refreshing might help.');
        });
        
        // Initialize particles
        function createParticles() {
            try {
                const particlesContainer = document.getElementById('particles');
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 20 + 's';
                    particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                    particlesContainer.appendChild(particle);
                }
            } catch (error) {
                console.error('Particle creation failed:', error);
            }
        }
        
        // Navigation - Fixed to handle clicks properly
        function switchSection(sectionId) {
            try {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.add('active');
                }
                
                // Find and activate the correct nav item
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    if (item.onclick && item.onclick.toString().includes(sectionId)) {
                        item.classList.add('active');
                    }
                });
                
                // Close mobile menu
                document.getElementById('navMenu').classList.remove('show');
                
                // Section-specific initializations
                if (sectionId === 'achievements') {
                    updateAchievements();
                } else if (sectionId === 'drinks') {
                    updateDrinkStats();
                    updateDrinkChart();
                } else if (sectionId === 'friends') {
                    updateFriendsList();
                }
            } catch (error) {
                console.error('Section switch failed:', error);
            }
        }
        
        function toggleMobileMenu() {
            document.getElementById('navMenu').classList.toggle('show');
        }
        
        // Toggle chart visibility
        function toggleChart() {
            chartVisible = !chartVisible;
            const wrapper = document.getElementById('chartWrapper');
            const toggleText = document.getElementById('chartToggleText');
            
            if (chartVisible) {
                wrapper.classList.remove('collapsed');
                toggleText.textContent = 'Hide Chart';
            } else {
                wrapper.classList.add('collapsed');
                toggleText.textContent = 'Show Chart';
            }
        }
        
        // Friend management
        function addFriend() {
            const name = document.getElementById('friendName').value.trim();
            const device = document.getElementById('friendDevice').value.trim();
            
            if (!name) {
                showNotification('❌ Please enter a friend\'s name');
                return;
            }
            
            const friendId = device || `friend_${Date.now()}`;
            
            partyData[friendId] = {
                name: name + ' 🎉',
                bac: 0,
                lastUpdate: Date.now(),
                location: 'Unknown',
                trend: 'steady',
                history: [],
                device: device,
                status: 'online',
                manual: true
            };
            
            // Save to Firebase if connected
            if (!DEMO_MODE && database) {
                database.ref('users/' + friendId).set(partyData[friendId]);
            }
            
            // Clear form
            document.getElementById('friendName').value = '';
            document.getElementById('friendDevice').value = '';
            
            showNotification(`✅ Added ${name} to your friends!`);
            updateUI();
            updateFriendsList();
        }
        
        function removeFriend(friendId) {
            if (confirm('Remove this friend?')) {
                delete partyData[friendId];
                
                // Remove from Firebase if connected
                if (!DEMO_MODE && database) {
                    database.ref('users/' + friendId).remove();
                }
                
                updateUI();
                updateFriendsList();
                showNotification('👋 Friend removed');
            }
        }
        
        function updateFriendsList() {
            const friendsList = document.getElementById('friendsList');
            if (!friendsList) return;
            
            friendsList.innerHTML = '';
            
            Object.entries(partyData).forEach(([id, friend]) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3>${friend.name}</h3>
                            <p>Device: ${friend.device || 'Not connected'}</p>
                            <p>Last Update: ${getTimeSince(friend.lastUpdate)}</p>
                        </div>
                        <button class="btn btn-danger" onclick="removeFriend('${id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                friendsList.appendChild(card);
            });
        }
        
        // Demo data generator with error handling
        function generateDemoData() {
            try {
                const names = ['Alex 🎓', 'Jordan 🎯', 'Sam 🎸', 'Casey 🎨', 'Morgan 🏀', 'Taylor 🎭', 'Jamie 🎪', 'Riley 🎵'];
                const locations = ['Dorm A', 'Dorm B', 'Library Cafe', 'Student Bar', 'Main Campus', 'Sports Center'];
                const now = Date.now();
                
                names.forEach((name, index) => {
                    if (!partyData[name]) {
                        partyData[name] = {
                            name: name,
                            bac: 0,
                            lastUpdate: now,
                            location: locations[Math.floor(Math.random() * locations.length)],
                            trend: 'steady',
                            history: [],
                            status: 'online',
                            lastMessage: ''
                        };
                    }
                    
                    // Simulate BAC changes
                    const currentBac = partyData[name].bac;
                    const change = (Math.random() - 0.3) * 0.02;
                    const newBac = Math.max(0, Math.min(currentBac + change, 0.12));
                    
                    partyData[name].trend = newBac > currentBac ? 'up' : newBac < currentBac ? 'down' : 'steady';
                    partyData[name].bac = newBac;
                    partyData[name].lastUpdate = now;
                    
                    // Add to history for charts
                    if (!partyData[name].history) partyData[name].history = [];
                    partyData[name].history.push({ time: now, value: newBac });
                    if (partyData[name].history.length > 50) {
                        partyData[name].history.shift();
                    }
                    
                    // Random location changes
                    if (Math.random() < 0.1) {
                        partyData[name].location = locations[Math.floor(Math.random() * locations.length)];
                    }
                    
                    // Random online/offline status
                    partyData[name].status = Math.random() < 0.9 ? 'online' : 'offline';
                });
                
                updateUI();
            } catch (error) {
                console.error('Data generation failed:', error);
            }
        }
        
        // Update UI with error handling
        function updateUI() {
            try {
                updateFriendsGrid();
                updateStats();
                updateLeaderboard();
                updateVisualizer();
                checkForAlerts();
                updateWeather();
            } catch (error) {
                console.error('UI update failed:', error);
            }
        }
        
        // Get BAC status
        function getBACStatus(bac) {
            if (bac < 0.02) return { class: 'bac-safe', text: 'Sober', emoji: '😊' };
            if (bac < 0.05) return { class: 'bac-caution', text: 'Buzzed', emoji: '😎' };
            if (bac < 0.08) return { class: 'bac-danger', text: 'No Driving!', emoji: '🚫' };
            return { class: 'bac-critical', text: 'Too Much!', emoji: '🤢' };
        }
        
        // Update friends grid
        function updateFriendsGrid() {
            const grid = document.getElementById('friendsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            Object.values(partyData).forEach(friend => {
                const status = getBACStatus(friend.bac);
                const timeSince = getTimeSince(friend.lastUpdate);
                
                const card = document.createElement('div');
                card.className = 'card friend-card';
                card.onclick = () => showFriendDetails(friend);
                
                const trendIcon = friend.trend === 'up' ? '📈' : friend.trend === 'down' ? '📉' : '➡️';
                const trendClass = friend.trend === 'up' ? 'trend-up' : friend.trend === 'down' ? 'trend-down' : '';
                
                card.innerHTML = `
                    <div class="friend-avatar">${friend.name.split(' ')[1]}</div>
                    <div class="friend-name">${friend.name.split(' ')[0]}</div>
                    <div class="bac-value ${status.class}">
                        ${friend.bac.toFixed(3)}‰
                        <span class="bac-trend ${trendClass}">${trendIcon}</span>
                    </div>
                    <div class="friend-status">
                        <span class="status-badge">${status.emoji} ${status.text}</span>
                    </div>
                    <div class="location-tag">
                        <i class="fas fa-map-marker-alt"></i> ${friend.location}
                    </div>
                    <div class="last-update" style="margin-top: 10px; opacity: 0.7; font-size: 0.9em;">
                        Updated ${timeSince}
                    </div>
                `;
                
                // Add pulse animation for high BAC
                if (friend.bac >= 0.08) {
                    card.classList.add('pulse');
                }
                
                grid.appendChild(card);
            });
        }
        
        // Update stats
        function updateStats() {
            const friends = Object.values(partyData);
            
            // Average BAC
            const avgBac = friends.reduce((sum, f) => sum + f.bac, 0) / friends.length || 0;
            const avgElement = document.getElementById('partyAverage');
            if (avgElement) avgElement.textContent = avgBac.toFixed(3) + '‰';
            
            // Safe friends
            const safeCount = friends.filter(f => f.bac < 0.02).length;
            const safeElement = document.getElementById('safeFriends');
            if (safeElement) safeElement.textContent = safeCount;
            
            // Update hydration timer
            const hydrationMinutes = 15 - (Date.now() % (15 * 60 * 1000)) / 60000;
            const hydrationElement = document.getElementById('hydrationTime');
            if (hydrationElement) hydrationElement.textContent = Math.floor(hydrationMinutes) + 'm';
            
            // Check achievements
            checkAchievements(friends);
        }
        
        // Update leaderboard
        function updateLeaderboard() {
            const leaderboard = document.getElementById('leaderboardList');
            if (!leaderboard) return;
            
            leaderboard.innerHTML = '';
            
            const sorted = Object.values(partyData)
                .sort((a, b) => a.bac - b.bac)
                .slice(0, 5);
            
            sorted.forEach((friend, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.onclick = () => {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                    showNotification(`${friend.name.split(' ')[0]} is winning! 🏆`);
                };
                
                item.innerHTML = `
                    <span class="rank rank-${index + 1}">#${index + 1}</span>
                    <span>${friend.name}</span>
                    <span>${friend.bac.toFixed(3)}‰</span>
                `;
                leaderboard.appendChild(item);
            });
        }
        
        // Music visualizer
        function updateVisualizer() {
            const visualizer = document.getElementById('visualizer');
            if (!visualizer) return;
            
            if (visualizer.children.length === 0) {
                for (let i = 0; i < 20; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    visualizer.appendChild(bar);
                }
            }
            
            visualizer.querySelectorAll('.bar').forEach(bar => {
                const height = Math.random() * 150 + 20;
                bar.style.height = height + 'px';
            });
        }
        
        // Party mode
        function startPartyMode() {
            partyMode = !partyMode;
            document.body.classList.toggle('party-mode');
            
            if (partyMode) {
                showNotification('🎉 PARTY MODE ACTIVATED! 🎉');
                // More frequent visualizer updates
                const vizInterval = setInterval(updateVisualizer, 100);
                
                // Random confetti
                const confettiInterval = setInterval(() => {
                    if (!partyMode) {
                        clearInterval(vizInterval);
                        clearInterval(confettiInterval);
                        return;
                    }
                    if (Math.random() < 0.3) {
                        confetti({
                            particleCount: 50,
                            spread: 60,
                            origin: { x: Math.random(), y: Math.random() }
                        });
                    }
                }, 5000);
                
                // Play party sound effect (if implemented)
                playSound('party-horn');
            } else {
                showNotification('Party mode deactivated');
            }
        }
        
        // Chat functionality
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message own';
                messageDiv.innerHTML = `
                    <div class="chat-author">You</div>
                    <div>${escapeHtml(message)}</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                input.value = '';
                
                // Check for commands
                processCommand(message);
                
                // Simulate response
                setTimeout(() => {
                    const names = Object.keys(partyData);
                    const randomName = names[Math.floor(Math.random() * names.length)];
                    const responses = [
                        "Haha that's awesome! 😂",
                        "See you there! 🎉",
                        "Who's up for another round? 🍻",
                        "Stay safe everyone! ❤️",
                        "Best party ever! 🔥",
                        "Let's gooo! 🚀",
                        "Anyone need a ride? 🚗",
                        "Water break time! 💧"
                    ];
                    const response = responses[Math.floor(Math.random() * responses.length)];
                    
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'chat-message';
                    responseDiv.innerHTML = `
                        <div class="chat-author">${randomName.split(' ')[0]}</div>
                        <div>${response}</div>
                    `;
                    chatMessages.appendChild(responseDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 1000 + Math.random() * 2000);
            }
        }
        
        function handleChatEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // Command processing
        function processCommand(message) {
            const lower = message.toLowerCase();
            
            if (lower.includes('party mode')) {
                startPartyMode();
            } else if (lower.includes('emergency')) {
                showModal('emergency');
            } else if (lower.includes('uber') || lower.includes('taxi')) {
                callUber();
            } else if (lower.includes('water') || lower.includes('hydrate')) {
                showHydrationReminder();
            } else if (lower.includes('game')) {
                switchSection('games');
            }
        }
        
        // Modal functions
        function showModal(type, data = null) {
            const modal = document.getElementById('modal');
            const modalBody = document.getElementById('modalBody');
            
            let content = '';
            
            switch(type) {
                case 'checkin':
                    content = `
                        <h2>📍 Check In</h2>
                        <p>Select your current location:</p>
                        <div class="location-map" id="locationMap">
                            <!-- Simulated map -->
                        </div>
                        <div style="margin: 20px 0;">
                            ${['Dorm A - Room Party', 'Student Bar', 'Library Cafe', 'Sports Center', 'Main Campus', 'Off Campus'].map(loc => 
                                `<button class="btn" style="width: 100%; margin: 10px 0;" onclick="checkInLocation('${loc}')">${loc}</button>`
                            ).join('')}
                        </div>
                        <button class="btn" onclick="closeModal()">Cancel</button>
                    `;
                    break;
                    
                case 'emergency':
                    content = `
                        <h2>🚨 Emergency Contacts</h2>
                        <div style="margin: 20px 0;">
                            <p><strong>Ambulance:</strong> 112</p>
                            <p><strong>HSG Security:</strong> +41 71 224 2424</p>
                            <p><strong>Poison Control:</strong> 145</p>
                            <p><strong>Mental Health Crisis:</strong> 143</p>
                        </div>
                        <button class="btn btn-danger" onclick="window.location.href='tel:112'">
                            <i class="fas fa-phone"></i> Call 112 Now
                        </button>
                        <button class="btn" onclick="showFirstAid()">
                            <i class="fas fa-medkit"></i> First Aid Guide
                        </button>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'first-aid':
                    content = `
                        <h2>🏥 First Aid Guide</h2>
                        <div class="first-aid-card">
                            <h3>Signs of Alcohol Poisoning:</h3>
                            <ul>
                                <li>Confusion, stupor</li>
                                <li>Vomiting</li>
                                <li>Seizures</li>
                                <li>Slow or irregular breathing</li>
                                <li>Unconsciousness</li>
                            </ul>
                        </div>
                        <div class="first-aid-card">
                            <h3>What to Do:</h3>
                            <div class="first-aid-step" data-step="1">Call 112 immediately</div>
                            <div class="first-aid-step" data-step="2">Keep them awake and sitting up</div>
                            <div class="first-aid-step" data-step="3">Give them water if conscious</div>
                            <div class="first-aid-step" data-step="4">Keep them warm</div>
                            <div class="first-aid-step" data-step="5">Stay with them</div>
                        </div>
                        <button class="btn btn-danger" onclick="window.location.href='tel:112'">Emergency Call</button>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'friend-details':
                    content = `
                        <h2>Friend Details</h2>
                        <div id="friendDetailsContent"></div>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'buddy-system':
                    content = `
                        <h2>👥 Buddy System</h2>
                        <p>Choose your buddy for tonight:</p>
                        <div class="buddy-list">
                            ${Object.values(partyData).map(friend => `
                                <div class="buddy-card" onclick="selectBuddy('${friend.name}')">
                                    <div style="font-size: 2em; margin-bottom: 10px;">${friend.name.split(' ')[1]}</div>
                                    <div>${friend.name.split(' ')[0]}</div>
                                    <div class="buddy-status ${friend.status}"></div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'safe-friends':
                    const safeFriends = Object.values(partyData).filter(f => f.bac < 0.02);
                    content = `
                        <h2>✅ Friends Safe to Drive</h2>
                        <div style="margin: 20px 0;">
                            ${safeFriends.length > 0 ? safeFriends.map(friend => `
                                <div class="buddy-card" style="margin: 10px 0;">
                                    <div>${friend.name}</div>
                                    <div>BAC: ${friend.bac.toFixed(3)}‰</div>
                                    <button class="btn" onclick="callFriend('${friend.name}')">
                                        <i class="fas fa-phone"></i> Call
                                    </button>
                                </div>
                            `).join('') : '<p>No friends are currently safe to drive.</p>'}
                        </div>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'locations':
                    content = `
                        <h2>📍 Active Party Locations</h2>
                        <div class="location-map" style="height: 400px;">
                            ${createLocationMap()}
                        </div>
                        <div style="margin: 20px 0;">
                            ${getActiveLocations().map(loc => `
                                <div class="buddy-card" style="margin: 10px 0;">
                                    <div><strong>${loc.name}</strong></div>
                                    <div>${loc.count} people</div>
                                    <div>Avg BAC: ${loc.avgBac.toFixed(3)}‰</div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
            }
            
            modalBody.innerHTML = content;
            modal.classList.add('show');
            
            // Initialize location map if needed
            if (type === 'checkin' || type === 'locations') {
                setTimeout(initializeLocationMap, 100);
            }
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }
        
        // Show friend details
        function showFriendDetails(friend) {
            showModal('friend-details');
            setTimeout(() => {
                const content = document.getElementById('friendDetailsContent');
                const status = getBACStatus(friend.bac);
                
                content.innerHTML = `
                    <div style="text-align: center; margin: 20px 0;">
                        <div class="friend-avatar" style="width: 100px; height: 100px; font-size: 3em; margin: 0 auto 20px;">
                            ${friend.name.split(' ')[1]}
                        </div>
                        <h3>${friend.name}</h3>
                        <div class="bac-value ${status.class}" style="font-size: 2em; margin: 20px 0;">
                            ${friend.bac.toFixed(3)}‰
                        </div>
                        <p><i class="fas fa-map-marker-alt"></i> ${friend.location}</p>
                        <div style="margin: 20px 0;">
                            <canvas id="friendChart" width="400" height="200"></canvas>
                        </div>
                        <div style="margin: 20px 0;">
                            <button class="btn" onclick="messageFriend('${friend.name}')">
                                <i class="fas fa-message"></i> Send Message
                            </button>
                            <button class="btn" onclick="callFriend('${friend.name}')">
                                <i class="fas fa-phone"></i> Call
                            </button>
                            <button class="btn" onclick="shareLocation('${friend.name}')">
                                <i class="fas fa-location-arrow"></i> Share Location
                            </button>
                        </div>
                    </div>
                `;
                
                // Draw friend's BAC chart
                drawFriendChart(friend);
            }, 100);
        }
        
        // Draw friend's BAC chart
        function drawFriendChart(friend) {
            const canvas = document.getElementById('friendChart');
            if (!canvas || !friend.history || friend.history.length === 0) return;
            
            const ctx = canvas.getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: friend.history.map((_, i) => i),
                    datasets: [{
                        label: 'BAC Level',
                        data: friend.history.map(h => h.value),
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 0.15
                        }
                    }
                }
            });
        }
        
        // Emergency functions
        function callEmergency(type) {
            switch(type) {
                case 'ambulance':
                    if (confirm('Call emergency services (112)?')) {
                        window.location.href = 'tel:112';
                    }
                    break;
                case 'campus-security':
                    if (confirm('Call HSG Campus Security?')) {
                        window.location.href = 'tel:+41712242424';
                    }
                    break;
                case 'taxi':
                    showNotification('🚕 Opening taxi options...');
                    setTimeout(() => {
                        showTaxiOptions();
                    }, 500);
                    break;
            }
        }
        
        function callUber() {
            const address = localStorage.getItem('homeAddress');
            
            if (address) {
                // Try to open Uber app with pre-filled destination
                const encodedAddress = encodeURIComponent(address);
                showNotification('🚕 Opening Uber with your home address...');
                
                // Copy address to clipboard
                navigator.clipboard.writeText(address)
                    .then(() => showNotification('📋 Home address copied to clipboard!'))
                    .catch(() => {});
                
                // Open Uber
                window.open(`https://m.uber.com/ul/?action=setPickup&pickup=my_location&dropoff[formatted_address]=${encodedAddress}`, '_blank');
            } else {
                showNotification('🚕 Opening Uber app...');
                window.open('https://m.uber.com/ul/', '_blank');
            }
        }
        
        function showTaxiOptions() {
            const address = localStorage.getItem('homeAddress') || '';
            const options = `
                <h2>🚕 Ride Options</h2>
                ${address ? `<div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <p><strong>Your Home Address:</strong></p>
                    <p>${escapeHtml(address)}</p>
                    <button class="btn" style="margin-top: 10px;" onclick="navigator.clipboard.writeText('${escapeHtml(address)}').then(() => showNotification('📋 Address copied!'))">
                        <i class="fas fa-copy"></i> Copy Address
                    </button>
                </div>` : ''}
                <div style="margin: 20px 0;">
                    <button class="btn" style="width: 100%; margin: 10px 0;" onclick="callUber()">
                        <i class="fab fa-uber"></i> Uber
                    </button>
                    <button class="btn" style="width: 100%; margin: 10px 0;" onclick="window.location.href='tel:+41712222222'">
                        <i class="fas fa-taxi"></i> Local Taxi
                    </button>
                    <button class="btn" style="width: 100%; margin: 10px 0;" onclick="callSoberFriend()">
                        <i class="fas fa-user-friends"></i> Call Sober Friend
                    </button>
                </div>
                <button class="btn" onclick="closeModal()">Cancel</button>
            `;
            
            document.getElementById('modalBody').innerHTML = options;
            document.getElementById('modal').classList.add('show');
        }
        
        function showFirstAid() {
            showModal('first-aid');
        }
        
        // Game functions
        function startGame(gameType) {
            currentGame = gameType;
            
            const gameOverlay = document.createElement('div');
            gameOverlay.className = 'game-overlay';
            gameOverlay.id = 'gameOverlay';
            
            let gameContent = '';
            
            switch(gameType) {
                case 'never-have-i-ever':
                    gameContent = createNeverHaveIEverGame();
                    break;
                case 'truth-or-dare':
                    gameContent = createTruthOrDareGame();
                    break;
                case 'kings-cup':
                    gameContent = createKingsCupGame();
                    break;
                case 'beer-pong':
                    gameContent = createBeerPongGame();
                    break;
                case 'flip-cup':
                    gameContent = createFlipCupGame();
                    break;
                case 'trivia':
                    gameContent = createTriviaGame();
                    break;
            }
            
            gameOverlay.innerHTML = `
                <div class="game-container">
                    <div class="game-header">
                        <div class="game-title">${getGameTitle(gameType)}</div>
                        <div class="close-game" onclick="closeGame()">×</div>
                    </div>
                    ${gameContent}
                </div>
            `;
            
            document.body.appendChild(gameOverlay);
            setTimeout(() => gameOverlay.classList.add('show'), 10);
            
            // Initialize game
            initializeGame(gameType);
            
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }
        
        function closeGame() {
            const overlay = document.getElementById('gameOverlay');
            if (overlay) {
                overlay.classList.remove('show');
                setTimeout(() => overlay.remove(), 500);
            }
            currentGame = null;
        }
        
        // Game creators
        function createNeverHaveIEverGame() {
            const questions = [
                "Never have I ever skipped a lecture for a party",
                "Never have I ever kissed someone at a HSG party",
                "Never have I ever failed an exam because of partying",
                "Never have I ever woken up in the library",
                "Never have I ever used ChatGPT for an assignment",
                "Never have I ever been to a professor's office hours drunk",
                "Never have I ever stolen food from a dorm kitchen",
                "Never have I ever dated someone from my study group"
            ];
            
            return `
                <div class="question-card" id="gameQuestion">
                    Click "Next Question" to start!
                </div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="nextNeverHaveIEver()">
                        <i class="fas fa-arrow-right"></i> Next Question
                    </button>
                </div>
                <div style="text-align: center; opacity: 0.7;">
                    <p>Drink if you've done it! 🍻</p>
                </div>
            `;
        }
        
        function createTruthOrDareGame() {
            return `
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" style="margin: 10px;" onclick="showTruth()">
                        <i class="fas fa-comment"></i> Truth
                    </button>
                    <button class="btn btn-danger" style="margin: 10px;" onclick="showDare()">
                        <i class="fas fa-fire"></i> Dare
                    </button>
                </div>
                <div class="question-card" id="gameQuestion">
                    Choose Truth or Dare!
                </div>
                <div id="playerName" style="text-align: center; font-size: 1.5em; margin-top: 20px;"></div>
            `;
        }
        
        function createKingsCupGame() {
            const rules = {
                'A': '🍉 Waterfall - Everyone drinks!',
                '2': '👉 You - Choose someone to drink',
                '3': '👈 Me - You drink!',
                '4': '👯 Floor - Last to touch floor drinks',
                '5': '🙋 Guys - All guys drink',
                '6': '💃 Chicks - All girls drink',
                '7': '🌈 Heaven - Last to raise hand drinks',
                '8': '🤝 Mate - Choose a drinking buddy',
                '9': '🎵 Rhyme - Say a word, others rhyme',
                '10': '📏 Categories - Name things in category',
                'J': '👑 Make a Rule',
                'Q': '❓ Questions - Ask questions only',
                'K': '🏆 King\'s Cup - Pour into center cup'
            };
            
            return `
                <div style="text-align: center;">
                    <div style="font-size: 6em; margin: 20px 0;" id="currentCard">🎴</div>
                    <button class="btn btn-primary" onclick="drawCard()">
                        <i class="fas fa-clone"></i> Draw Card
                    </button>
                </div>
                <div class="question-card" id="gameQuestion">
                    Click "Draw Card" to start!
                </div>
            `;
        }
        
        function createBeerPongGame() {
            return `
                <div class="score-display">
                    <div class="team-score">
                        <div class="team-name">Team 1</div>
                        <div class="team-points" id="team1Score">0</div>
                        <button class="btn" onclick="addScore('team1')">+1</button>
                    </div>
                    <div class="team-score">
                        <div class="team-name">Team 2</div>
                        <div class="team-points" id="team2Score">0</div>
                        <button class="btn" onclick="addScore('team2')">+1</button>
                    </div>
                </div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="resetBeerPong()">
                        <i class="fas fa-redo"></i> New Game
                    </button>
                </div>
                <div id="gameStatus" style="text-align: center; font-size: 1.5em; margin-top: 20px;"></div>
            `;
        }
        
        function createFlipCupGame() {
            return `
                <div class="timer-display" id="flipTimer">00:00</div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" id="timerBtn" onclick="toggleFlipTimer()">
                        <i class="fas fa-play"></i> Start Timer
                    </button>
                    <button class="btn" onclick="resetFlipTimer()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
                <div id="bestTime" style="text-align: center; font-size: 1.2em; margin-top: 20px;">
                    Best Time: --:--
                </div>
            `;
        }
        
        function createTriviaGame() {
            return `
                <div class="question-card" id="gameQuestion">
                    Click "Next Question" to start HSG Trivia!
                </div>
                <div id="triviaOptions" style="margin: 20px 0;"></div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="nextTrivia()">
                        <i class="fas fa-arrow-right"></i> Next Question
                    </button>
                </div>
                <div class="score-display">
                    <div class="team-score">
                        <div class="team-name">Score</div>
                        <div class="team-points" id="triviaScore">0</div>
                    </div>
                </div>
            `;
        }
        
        // Game logic
        let gameData = {
            neverHaveIEver: [
                "Never have I ever skipped a lecture for a party",
                "Never have I ever kissed someone at a HSG party",
                "Never have I ever failed an exam because of partying",
                "Never have I ever woken up in the library",
                "Never have I ever used ChatGPT for an assignment",
                "Never have I ever been to a professor's office hours drunk",
                "Never have I ever stolen food from a dorm kitchen",
                "Never have I ever dated someone from my study group",
                "Never have I ever fallen asleep during a presentation",
                "Never have I ever pretended to be sick to avoid a group project"
            ],
            truths: [
                "What's your most embarrassing HSG moment?",
                "Who's your secret crush on campus?",
                "What's the worst grade you've ever gotten?",
                "Have you ever cheated on an exam?",
                "What's your biggest fear about graduation?",
                "Which professor do you have a crush on?",
                "What's the craziest thing you've done at HSG?"
            ],
            dares: [
                "Text your crush right now!",
                "Do 20 pushups",
                "Sing the HSG anthem",
                "Call a random contact and say 'I love you'",
                "Post an embarrassing photo on Instagram",
                "Dance without music for 1 minute",
                "Let someone go through your phone for 30 seconds"
            ],
            trivia: [
                {
                    question: "When was HSG founded?",
                    options: ["1898", "1923", "1945", "1967"],
                    correct: 0
                },
                {
                    question: "What does HSG stand for?",
                    options: ["High School Gymnasium", "Hochschule St. Gallen", "Higher Studies Group", "Helvetic Study Group"],
                    correct: 1
                },
                {
                    question: "How many students attend HSG?",
                    options: ["5,000", "9,000", "12,000", "15,000"],
                    correct: 1
                },
                {
                    question: "What's the most popular major at HSG?",
                    options: ["Law", "Business Administration", "Computer Science", "International Affairs"],
                    correct: 1
                }
            ]
        };
        
        let gameState = {
            flipTimer: null,
            flipTime: 0,
            bestFlipTime: null,
            triviaScore: 0,
            currentTriviaIndex: 0
        };
        
        function initializeGame(gameType) {
            switch(gameType) {
                case 'beer-pong':
                    gameScores = { team1: 0, team2: 0 };
                    updateBeerPongScore();
                    break;
                case 'trivia':
                    gameState.triviaScore = 0;
                    gameState.currentTriviaIndex = 0;
                    document.getElementById('triviaScore').textContent = '0';
                    break;
            }
        }
        
        function nextNeverHaveIEver() {
            const questions = gameData.neverHaveIEver;
            const random = Math.floor(Math.random() * questions.length);
            document.getElementById('gameQuestion').textContent = questions[random];
        }
        
        function showTruth() {
            const truths = gameData.truths;
            const random = Math.floor(Math.random() * truths.length);
            document.getElementById('gameQuestion').textContent = truths[random];
            selectRandomPlayer();
        }
        
        function showDare() {
            const dares = gameData.dares;
            const random = Math.floor(Math.random() * dares.length);
            document.getElementById('gameQuestion').textContent = dares[random];
            selectRandomPlayer();
        }
        
        function selectRandomPlayer() {
            const players = Object.keys(partyData);
            const random = Math.floor(Math.random() * players.length);
            const player = players[random].split(' ')[0];
            document.getElementById('playerName').textContent = `${player}'s turn!`;
        }
        
        function drawCard() {
            const cards = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const suits = ['♠️', '♥️', '♦️', '♣️'];
            const randomCard = cards[Math.floor(Math.random() * cards.length)];
            const randomSuit = suits[Math.floor(Math.random() * suits.length)];
            
            document.getElementById('currentCard').textContent = randomCard + randomSuit;
            
            const rules = {
                'A': '🍉 Waterfall - Everyone drinks!',
                '2': '👉 You - Choose someone to drink',
                '3': '👈 Me - You drink!',
                '4': '👯 Floor - Last to touch floor drinks',
                '5': '🙋 Guys - All guys drink',
                '6': '💃 Chicks - All girls drink',
                '7': '🌈 Heaven - Last to raise hand drinks',
                '8': '🤝 Mate - Choose a drinking buddy',
                '9': '🎵 Rhyme - Say a word, others rhyme',
                '10': '📏 Categories - Name things in category',
                'J': '👑 Make a Rule',
                'Q': '❓ Questions - Ask questions only',
                'K': '🏆 King\'s Cup - Pour into center cup'
            };
            
            document.getElementById('gameQuestion').textContent = rules[randomCard];
        }
        
        function addScore(team) {
            gameScores[team]++;
            updateBeerPongScore();
            
            if (gameScores[team] >= 10) {
                document.getElementById('gameStatus').textContent = `${team === 'team1' ? 'Team 1' : 'Team 2'} Wins! 🏆`;
                confetti({
                    particleCount: 200,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }
        
        function updateBeerPongScore() {
            document.getElementById('team1Score').textContent = gameScores.team1;
            document.getElementById('team2Score').textContent = gameScores.team2;
        }
        
        function resetBeerPong() {
            gameScores = { team1: 0, team2: 0 };
            updateBeerPongScore();
            document.getElementById('gameStatus').textContent = '';
        }
        
        function toggleFlipTimer() {
            const btn = document.getElementById('timerBtn');
            
            if (gameState.flipTimer) {
                clearInterval(gameState.flipTimer);
                gameState.flipTimer = null;
                btn.innerHTML = '<i class="fas fa-play"></i> Start Timer';
                
                if (!gameState.bestFlipTime || gameState.flipTime < gameState.bestFlipTime) {
                    gameState.bestFlipTime = gameState.flipTime;
                    document.getElementById('bestTime').textContent = `Best Time: ${formatTime(gameState.bestFlipTime)}`;
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
            } else {
                gameState.flipTime = 0;
                gameState.flipTimer = setInterval(() => {
                    gameState.flipTime++;
                    document.getElementById('flipTimer').textContent = formatTime(gameState.flipTime);
                }, 10);
                btn.innerHTML = '<i class="fas fa-pause"></i> Stop Timer';
            }
        }
        
        function resetFlipTimer() {
            if (gameState.flipTimer) {
                clearInterval(gameState.flipTimer);
                gameState.flipTimer = null;
            }
            gameState.flipTime = 0;
            document.getElementById('flipTimer').textContent = '00:00';
            document.getElementById('timerBtn').innerHTML = '<i class="fas fa-play"></i> Start Timer';
        }
        
        function formatTime(centiseconds) {
            const minutes = Math.floor(centiseconds / 6000);
            const seconds = Math.floor((centiseconds % 6000) / 100);
            const cs = centiseconds % 100;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${cs.toString().padStart(2, '0')}`;
        }
        
        function nextTrivia() {
            const trivia = gameData.trivia;
            const current = trivia[gameState.currentTriviaIndex % trivia.length];
            
            document.getElementById('gameQuestion').textContent = current.question;
            
            const optionsHtml = current.options.map((option, index) => 
                `<button class="btn" style="width: 100%; margin: 10px 0;" onclick="answerTrivia(${index}, ${current.correct})">${option}</button>`
            ).join('');
            
            document.getElementById('triviaOptions').innerHTML = optionsHtml;
            gameState.currentTriviaIndex++;
        }
        
        function answerTrivia(selected, correct) {
            const buttons = document.getElementById('triviaOptions').querySelectorAll('button');
            
            if (selected === correct) {
                gameState.triviaScore++;
                document.getElementById('triviaScore').textContent = gameState.triviaScore;
                buttons[selected].style.background = 'linear-gradient(45deg, #00ff88, #00d4ff)';
                showNotification('✅ Correct! +1 point');
            } else {
                buttons[selected].style.background = 'linear-gradient(45deg, #ff4444, #ff0088)';
                buttons[correct].style.background = 'linear-gradient(45deg, #00ff88, #00d4ff)';
                showNotification('❌ Wrong answer!');
            }
            
            // Disable all buttons
            buttons.forEach(btn => btn.disabled = true);
            
            // Auto next question after 2 seconds
            setTimeout(nextTrivia, 2000);
        }
        
        function getGameTitle(gameType) {
            const titles = {
                'never-have-i-ever': '🙊 Never Have I Ever',
                'truth-or-dare': '🎯 Truth or Dare',
                'kings-cup': '👑 King\'s Cup',
                'beer-pong': '🏓 Beer Pong',
                'flip-cup': '🥤 Flip Cup',
                'trivia': '🧠 HSG Trivia'
            };
            return titles[gameType] || 'Party Game';
        }
        
        // Location functions
        function checkInLocation(location) {
            locationHistory.push({
                location: location,
                time: Date.now(),
                user: currentUser
            });
            
            showNotification(`📍 Checked in at ${location}!`);
            
            // Update achievement
            if (locationHistory.length >= 10) {
                achievements.partyAnimal = true;
                showAchievementUnlocked('Party Animal');
            }
            
            closeModal();
        }
        
        function createLocationMap() {
            // Simulated map with dots
            const locations = getActiveLocations();
            let mapHtml = '<div style="position: relative; width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 20px;">';
            
            locations.forEach((loc, index) => {
                const x = 20 + (index % 3) * 30;
                const y = 20 + Math.floor(index / 3) * 30;
                mapHtml += `
                    <div class="location-dot" style="left: ${x}%; top: ${y}%;" title="${loc.name}: ${loc.count} people">
                        <span style="position: absolute; top: -20px;